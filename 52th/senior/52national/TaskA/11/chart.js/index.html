<!DOCTYPE html>
<html>
<head>
	<title>Population Bar Chart</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/csvtojson/dist/csvtojson.min.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</head>
<body>
	<input type="file" id="fileinput" onchange="handleFile()">
	<div>
		<canvas id="canva"></canvas>
	</div>

	<div class="modal fade" id="popup" tabindex="-1" aria-labelledby="popupLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="popupLabel">District Population</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body" id="popupBody">
				</div>
			</div>
		</div>
	</div>

	<script>
		let chartData = {};

		function handleFile() {
			const file = document.getElementById('fileinput').files[0];
			const reader = new FileReader();
			reader.onload = async function(event) {
				const csvData = event.target.result;
				const jsonArray = await csv().fromString(csvData);

				chartData = {};
				for (let i = 0; i < jsonArray.length; i++) {
					const city = jsonArray[i].縣市;
					const district = jsonArray[i].鄉鎮市區;
					const population = parseInt(jsonArray[i].男生人數) + parseInt(jsonArray[i].女生人數);
					if (!chartData[city]) {
						chartData[city] = {};
					}
					chartData[city][district] = population;
				}

				renderChart();
			}
			reader.readAsText(file);
		}

		function renderChart() {
			const ctx = document.getElementById('canva').getContext('2d');
			const labels = Object.keys(chartData);
			const data = [];
			for (let i = 0; i < labels.length; i++) {
				const city = labels[i];
				let population = 0;
				Object.values(chartData[city]).forEach(value => population += value);
				data.push(population);
			}

			const chart = new Chart(ctx, {
				type: 'bar',
				data: {
					labels: labels,
					datasets: [{
						label: 'Population',
						data: data,
						backgroundColor: 'rgba(54, 162, 235, 0.2)',
						borderColor: 'rgba(54, 162, 235, 1)',
						borderWidth: 1
					}]
				},
				options: {
					scales: {
						y: {
							beginAtZero: true
						}
					},
					onClick: function(event, chartElement) {
						if (chartElement.length > 0) {
							const city = chart
                            const datasetIndex = chartElement[0].datasetIndex;
                            const district = chartData[labels[datasetIndex]];
                            let popupHtml = '<table class="table">';
                            Object.keys(district).forEach(key => {
                            popupHtml += '<tr>';
                            popupHtml += '<td>' + key + '</td>';
                            popupHtml += '<td>' + district[key] + '</td>';
                            popupHtml += '</tr>';
                            });
                            popupHtml += '</table>';
						document.getElementById('popupBody').innerHTML = popupHtml;
						const popup = new bootstrap.Modal(document.getElementById('popup'));
						popup.show();
					}
				}
			}
		});
	}
</script>
</body>
</html>